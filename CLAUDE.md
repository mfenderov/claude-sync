# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**claude-sync** is a CLI tool for syncing Claude Code configurations (`~/.claude`) across machines using git. Built with Go 1.25 and [Charm](https://charm.sh/) TUI libraries.

## Commands

```bash
task test           # Run tests (generates mocks first)
task build          # Build binary to bin/claude-sync
task lint           # Run golangci-lint
task ci             # All CI checks (tidy + fmt + vet + lint + test)
task generate-mocks # Generate mocks using mockery
task dev -- [args]  # Run in dev mode with arguments
```

Run single test:
```bash
go test -v -run TestService_Run_NormalSync ./internal/sync/
```

## Architecture

### Dependency Injection Pattern
The codebase uses **interface-based dependency injection** for testability. The core pattern:

1. **Interfaces** (`internal/sync/interfaces.go`): Define contracts for `GitOperator`, `Prompter`, `Logger`
2. **Real Implementations** (`internal/git/`, `internal/prompts/`, `internal/logger/`): Production code
3. **Adapters** (`internal/sync/adapters.go`): Bridge interfaces to real implementations
4. **Mocks** (`*_mock.go`): Auto-generated by mockery for testing

### Package Structure

- `cmd/` - Cobra commands (root, sync, status, version)
- `internal/sync/` - Core business logic (`Service` struct orchestrates sync flow)
- `internal/git/` - Git operations (all take `context.Context` for cancellation)
- `internal/prompts/` - TUI prompts using Charm's bubbletea/bubbles
- `internal/logger/` - Styled console output using lipgloss
- `internal/ui/` - Shared UI styles
- `internal/version/` - Build version info (injected via ldflags)

### Sync Flow (`internal/sync/service.go`)
The `Service.Run()` method handles:
1. First-time setup (clone existing or init fresh)
2. Normal sync: commit local changes → pull with rebase → push
3. Conflict detection and safe abort

## Testing

- Tests use **mockery-generated mocks** (not real git operations)
- Mock files are named `*_mock.go` and regenerated via `task generate-mocks`
- E2E tests (`e2e_test.go`, `service_e2e_test.go`) use real git repos in temp directories
- Tests run with `-race` flag for race condition detection

## Go Tool Dependencies

Tools are managed via `go.mod` tool directive (Go 1.24+):
- `golangci-lint` - linting
- `mockery` - mock generation
- `gotestsum` - test runner

Run tools with: `go tool <name>`
